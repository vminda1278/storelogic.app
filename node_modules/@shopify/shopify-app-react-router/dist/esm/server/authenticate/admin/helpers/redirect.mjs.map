{"version":3,"file":"redirect.mjs","sources":["../../../../../../../src/server/authenticate/admin/helpers/redirect.ts"],"sourcesContent":["import {redirect as reactRouterRedirect} from 'react-router';\n\nimport {BasicParams, AppDistribution} from '../../../types';\nimport {getSessionTokenHeader} from '../../helpers/get-session-token-header';\n\nimport {renderAppBridge} from './render-app-bridge';\nimport {redirectWithAppBridgeHeaders} from './redirect-with-app-bridge-headers';\n\nexport type RedirectTarget = '_self' | '_parent' | '_top' | '_blank';\nexport type RedirectInit = number | (ResponseInit & {target?: RedirectTarget});\nexport type RedirectFunction = (url: string, init?: RedirectInit) => Response;\n\ninterface ParseURLOptions {\n  params: BasicParams;\n  url: string;\n  base: string;\n  shop: string;\n  init: RedirectInit;\n}\n\ninterface ParsedURL {\n  url: URL;\n  target: RedirectTarget;\n}\n\nexport function redirectFactory(\n  params: BasicParams,\n  request: Request,\n  shop: string,\n): RedirectFunction {\n  const {config, logger} = params;\n\n  return function redirect(url, init: RedirectInit) {\n    const {searchParams} = new URL(request.url);\n    const {url: parsedUrl, target} = parseURL({\n      params,\n      url,\n      base: config.appUrl,\n      shop,\n      init,\n    });\n\n    logger.debug('Redirecting', {shop, url: parsedUrl.toString()});\n\n    const isSameOrigin = parsedUrl.origin === config.appUrl;\n    if (isSameOrigin || url.startsWith('/')) {\n      searchParams.forEach((value, key) => {\n        if (!parsedUrl.searchParams.has(key)) {\n          parsedUrl.searchParams.set(key, value);\n        }\n      });\n    }\n\n    if (target === '_self') {\n      if (isBounceRequest(request)) {\n        throw renderAppBridge(params, request, {\n          url: parsedUrl.toString(),\n          target,\n        });\n      } else {\n        return reactRouterRedirect(parsedUrl.toString(), init);\n      }\n    } else if (isDataRequest(request)) {\n      throw redirectWithAppBridgeHeaders(parsedUrl.toString());\n    } else if (isEmbeddedRequest(request)) {\n      throw renderAppBridge(params, request, {\n        url: parsedUrl.toString(),\n        target,\n      });\n    }\n    return reactRouterRedirect(url, init);\n  };\n}\n\nfunction isBounceRequest(request: Request) {\n  return (\n    Boolean(getSessionTokenHeader(request)) &&\n    request.headers.has('X-Shopify-Bounce')\n  );\n}\n\nfunction isDataRequest(request: Request) {\n  const isGet = request.method === 'GET';\n  const sessionTokenHeader = Boolean(getSessionTokenHeader(request));\n\n  return (\n    sessionTokenHeader &&\n    !isBounceRequest(request) &&\n    (!isEmbeddedRequest(request) || !isGet)\n  );\n}\n\nfunction isEmbeddedRequest(request: Request) {\n  const {searchParams} = new URL(request.url);\n\n  return searchParams.get('embedded') === '1';\n}\n\nfunction parseURL({params, base, init, shop, url}: ParseURLOptions): ParsedURL {\n  let target: RedirectTarget | undefined =\n    typeof init !== 'number' && init?.target ? init.target : undefined;\n\n  if (isAdminRemotePath(url)) {\n    const {config} = params;\n\n    const adminPath = getAdminRemotePath(url);\n    const cleanShopName = shop.replace('.myshopify.com', '');\n\n    if (!target) {\n      target =\n        config.distribution === AppDistribution.ShopifyAdmin\n          ? '_self'\n          : '_parent';\n    }\n\n    return {\n      url: new URL(\n        `https://admin.shopify.com/store/${cleanShopName}${adminPath}`,\n      ),\n      target,\n    };\n  } else {\n    return {\n      url: new URL(url, base),\n      target: target ?? '_self',\n    };\n  }\n}\n\nconst ADMIN_REGEX = /^shopify:\\/*admin\\//i;\n\nfunction isAdminRemotePath(url: string) {\n  return ADMIN_REGEX.test(url);\n}\n\nfunction getAdminRemotePath(url: string | URL) {\n  const parsedUrl = removeRestrictedParams(new URL(url)).href;\n  return parsedUrl.replace(ADMIN_REGEX, '/');\n}\n\nconst embeddedFrameParamsToRemove = [\n  'hmac',\n  'locale',\n  'protocol',\n  'session',\n  'id_token',\n  'shop',\n  'timestamp',\n  'host',\n  'embedded',\n  // sent when clicking rel=\"home\" nav item\n  'appLoadId',\n];\n\nfunction removeRestrictedParams(url: URL | string) {\n  const newUrl = new URL(url);\n  embeddedFrameParamsToRemove.forEach((param) =>\n    newUrl.searchParams.delete(param),\n  );\n  return newUrl;\n}\n"],"names":["redirect","reactRouterRedirect"],"mappings":"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"}